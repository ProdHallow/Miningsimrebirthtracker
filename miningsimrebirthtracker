local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- // 1. CLEANUP PREVIOUS INSTANCES (Prevents Duplication) //
local function Cleanup()
    if PlayerGui:FindFirstChild("ScreenGui") and PlayerGui.ScreenGui:FindFirstChild("StatsFrame") then
        local existing = PlayerGui.ScreenGui.StatsFrame:FindFirstChild("TrackerContainer")
        if existing then existing:Destroy() end
        
        -- Clean up old loose elements from previous versions just in case
        local oldNames = {"RebirthTracker", "1min", "5min", "Start", "Custom", "Set", "ResultLabel", "TrackerElements"}
        for _, name in pairs(oldNames) do
            local old = PlayerGui.ScreenGui.StatsFrame:FindFirstChild(name)
            if old then old:Destroy() end
        end
    end
end
Cleanup()

-- // 2. WAIT FOR GAME LOAD //
repeat task.wait() until game:IsLoaded()

local function WaitForStats()
    local timeout = tick() + 30
    while tick() < timeout do
        local success = pcall(function()
            local leaderstats = LocalPlayer:WaitForChild("leaderstats", 1)
            local screenGui = PlayerGui:WaitForChild("ScreenGui", 1)
            local statsFrame = screenGui:WaitForChild("StatsFrame", 1)
            
            if not leaderstats or not statsFrame then error("Waiting...") end
            
            -- Check specifically for the stats we need
            if not leaderstats:FindFirstChild("Blocks Mined") then error("No blocks stat") end
        end)
        
        if success then return true end
        task.wait(1)
    end
    return false
end

if not WaitForStats() then
    warn("Failed to load Leaderstats or GUI. Script stopped to prevent errors.")
    return
end

-- // 3. VARIABLES & STATE //
local ScreenGui = PlayerGui.ScreenGui
local StatsFrame = ScreenGui.StatsFrame
local Leaderstats = LocalPlayer.leaderstats

local State = {
    Running = false,
    TimeOption = nil,
    WaitTime = 0,
    StartBlocks = 0,
    StartRebirths = 0,
    ElapsedTime = 0,
    Stopping = false
}

-- // 4. UI CONSTRUCTION (Using Layouts to prevent Overlaps) //

-- Create a Holder Frame that sits above the StatsFrame
local Container = Instance.new("Frame")
Container.Name = "TrackerContainer"
Container.Parent = StatsFrame
Container.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
Container.BackgroundTransparency = 1
-- Positioned slightly above the StatsFrame, stretching upwards
Container.Position = UDim2.new(0, 0, -3.2, 0) 
Container.Size = UDim2.new(1, 0, 3, 0)
Container.ZIndex = 10

-- Add Layout (This automatically stacks items so they NEVER overlap)
local Layout = Instance.new("UIListLayout")
Layout.Parent = Container
Layout.SortOrder = Enum.SortOrder.LayoutOrder
Layout.VerticalAlignment = Enum.VerticalAlignment.Bottom
Layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
Layout.Padding = UDim.new(0, 5)

-- Helper function to create the rounded look
local function CreateRoundedFrame(name, height, layoutOrder)
    local frame = Instance.new("ImageLabel")
    frame.Name = name
    frame.Parent = Container
    frame.BackgroundTransparency = 1
    frame.Size = UDim2.new(0.95, 0, 0, height) -- 95% width to fit nicely
    frame.Image = "rbxassetid://1511196841" -- Slice image
    frame.ImageColor3 = Color3.fromRGB(39, 180, 255) -- Blue
    frame.ScaleType = Enum.ScaleType.Slice
    frame.SliceCenter = Rect.new(9, 11, 91, 89)
    frame.LayoutOrder = layoutOrder
    return frame
end

-- --- ELEMENT 1: CUSTOM INPUT ROW ---
local CustomRow = CreateRoundedFrame("CustomRow", 35, 1)
CustomRow.ImageColor3 = Color3.fromRGB(248, 248, 248) -- Lighter background for input

local TimeInput = Instance.new("TextBox")
TimeInput.Parent = CustomRow
TimeInput.BackgroundTransparency = 1
TimeInput.Position = UDim2.new(0.05, 0, 0, 0)
TimeInput.Size = UDim2.new(0.65, 0, 1, 0)
TimeInput.Font = Enum.Font.Arial
TimeInput.Text = "Time (s)"
TimeInput.PlaceholderText = "Time (s)"
TimeInput.TextColor3 = Color3.fromRGB(100, 100, 100)
TimeInput.TextSize = 14
TimeInput.ClearTextOnFocus = true

local SetButton = Instance.new("TextButton")
SetButton.Name = "SetBtn"
SetButton.Parent = CustomRow
SetButton.BackgroundTransparency = 1
SetButton.Position = UDim2.new(0.7, 0, 0, 0)
SetButton.Size = UDim2.new(0.3, 0, 1, 0)
SetButton.Font = Enum.Font.ArialBold
SetButton.Text = "SET"
SetButton.TextColor3 = Color3.fromRGB(39, 180, 255)
SetButton.TextSize = 14

-- --- ELEMENT 2: PRESET BUTTONS ROW ---
local PresetRow = Instance.new("Frame")
PresetRow.Name = "PresetRow"
PresetRow.Parent = Container
PresetRow.BackgroundTransparency = 1
PresetRow.Size = UDim2.new(0.95, 0, 0, 35)
PresetRow.LayoutOrder = 2

local Min1Frame = Instance.new("ImageLabel") -- 1 Min Wrapper
Min1Frame.Parent = PresetRow
Min1Frame.BackgroundTransparency = 1
Min1Frame.Size = UDim2.new(0.48, 0, 1, 0)
Min1Frame.Image = "rbxassetid://1511196841"
Min1Frame.ImageColor3 = Color3.fromRGB(39, 180, 255)
Min1Frame.ScaleType = Enum.ScaleType.Slice
Min1Frame.SliceCenter = Rect.new(9, 11, 91, 89)

local Min1Btn = Instance.new("TextButton")
Min1Btn.Parent = Min1Frame
Min1Btn.BackgroundTransparency = 1
Min1Btn.Size = UDim2.new(1, 0, 1, 0)
Min1Btn.Font = Enum.Font.ArialBold
Min1Btn.Text = "1 MIN"
Min1Btn.TextColor3 = Color3.fromRGB(255, 255, 255)
Min1Btn.TextSize = 14

local Min5Frame = Min1Frame:Clone() -- 5 Min Wrapper
Min5Frame.Parent = PresetRow
Min5Frame.Position = UDim2.new(0.52, 0, 0, 0)

local Min5Btn = Min5Frame:FindFirstChildOfClass("TextButton")
Min5Btn.Text = "5 MIN"

-- --- ELEMENT 3: START BUTTON ---
local StartFrame = CreateRoundedFrame("StartFrame", 40, 3)

local StartButton = Instance.new("TextButton")
StartButton.Parent = StartFrame
StartButton.BackgroundTransparency = 1
StartButton.Size = UDim2.new(1, 0, 1, 0)
StartButton.Font = Enum.Font.ArialBold
StartButton.Text = "START TRACKING"
StartButton.TextColor3 = Color3.fromRGB(255, 255, 255)
StartButton.TextSize = 16

-- --- ELEMENT 4: STATUS/DISPLAY LABEL ---
local StatusFrame = CreateRoundedFrame("StatusFrame", 30, 4)
StatusFrame.ImageColor3 = Color3.fromRGB(30, 30, 30)
StatusFrame.ImageTransparency = 0.5

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Parent = StatusFrame
StatusLabel.BackgroundTransparency = 1
StatusLabel.Size = UDim2.new(1, 0, 1, 0)
StatusLabel.Font = Enum.Font.Arial
StatusLabel.Text = "Select a time to begin"
StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
StatusLabel.TextSize = 14

-- // 5. LOGIC & FUNCTIONS //

local function FormatNumber(num)
    local formatted = tostring(num)
    while true do
        local k
        formatted, k = string.gsub(formatted, "^(-?%d+)(%d%d%d)", "%1,%2")
        if k == 0 then break end
    end
    return formatted
end

local function GetStats()
    local blocks = 0
    local rebirths = 0
    
    if Leaderstats:FindFirstChild("Blocks Mined") then
        blocks = Leaderstats["Blocks Mined"].Value
    end
    if Leaderstats:FindFirstChild("Rebirths") then
        rebirths = Leaderstats["Rebirths"].Value
    end
    
    return blocks, rebirths
end

local function ResetVisuals()
    Min1Btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    Min5Btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    SetButton.TextColor3 = Color3.fromRGB(39, 180, 255)
end

local function ResetState()
    State.Running = false
    State.Stopping = false
    State.ElapsedTime = 0
    StartButton.Text = "START TRACKING"
    StartButton.TextColor3 = Color3.fromRGB(255, 255, 255)
end

local function StartTracking()
    -- Check selection
    if State.WaitTime <= 0 then
        StatusLabel.Text = "Please select a time first!"
        return
    end
    
    -- Handle Stopping
    if State.Running then
        State.Stopping = true
        StatusLabel.Text = "Stopping..."
        return
    end
    
    -- Initialize
    State.Running = true
    State.Stopping = false
    State.ElapsedTime = 0
    
    StartButton.Text = "STOP"
    StartButton.TextColor3 = Color3.fromRGB(255, 100, 100)
    StatusLabel.Text = "Starting in 3..."
    
    -- Countdown
    for i = 3, 1, -1 do
        if State.Stopping then ResetState(); StatusLabel.Text = "Cancelled"; return end
        StatusLabel.Text = "Starting in " .. i .. "..."
        task.wait(1)
    end
    
    if State.Stopping then ResetState(); StatusLabel.Text = "Cancelled"; return end

    -- Capture Base Stats
    State.StartBlocks, State.StartRebirths = GetStats()
    
    local remaining = State.WaitTime
    
    -- Main Loop
    while remaining > 0 do
        if State.Stopping then break end
        StatusLabel.Text = "Time Left: " .. remaining .. "s"
        task.wait(1)
        remaining = remaining - 1
        State.ElapsedTime = State.ElapsedTime + 1
    end
    
    -- Final Calculation
    local endBlocks, endRebirths = GetStats()
    local gainedBlocks = math.max(0, endBlocks - State.StartBlocks)
    local gainedRebirths = math.max(0, endRebirths - State.StartRebirths)
    
    local timeText = State.Stopping and State.ElapsedTime or State.WaitTime
    
    StatusLabel.Text = "B: " .. FormatNumber(gainedBlocks) .. " | R: " .. FormatNumber(gainedRebirths)
    
    ResetState()
end

-- // 6. BUTTON CONNECTIONS //

Min1Btn.MouseButton1Click:Connect(function()
    if State.Running then return end
    ResetVisuals()
    
    if State.TimeOption == "1min" then
        State.TimeOption = nil
        State.WaitTime = 0
    else
        State.TimeOption = "1min"
        State.WaitTime = 60
        Min1Btn.TextColor3 = Color3.fromRGB(85, 255, 0)
    end
end)

Min5Btn.MouseButton1Click:Connect(function()
    if State.Running then return end
    ResetVisuals()
    
    if State.TimeOption == "5min" then
        State.TimeOption = nil
        State.WaitTime = 0
    else
        State.TimeOption = "5min"
        State.WaitTime = 300
        Min5Btn.TextColor3 = Color3.fromRGB(85, 255, 0)
    end
end)

SetButton.MouseButton1Click:Connect(function()
    if State.Running then return end
    ResetVisuals()
    
    local num = tonumber(TimeInput.Text)
    if num and num > 0 then
        State.TimeOption = "Custom"
        State.WaitTime = num
        SetButton.TextColor3 = Color3.fromRGB(85, 255, 0)
    else
        StatusLabel.Text = "Invalid Number"
    end
end)

StartButton.MouseButton1Click:Connect(function()
    task.spawn(StartTracking)
end)

print("Rebirth Tracker Loaded - No Overlaps Version")
